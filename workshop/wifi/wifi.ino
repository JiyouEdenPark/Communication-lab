// ============================================================================
// WiFi 신호 강도 모니터 - 서보 모터 제어
// ============================================================================
// 이 코드는 WiFi 신호 강도를 확인하고, 신호 강도에 따라 서보 모터를 제어합니다.
// 신호가 강할수록 서보 모터가 더 많이 돌아갑니다 (3단계: 90도, 45도, 0도)
// ============================================================================

#include <WiFiNINA.h>
#include <Servo.h>

// ============================================================================
// 설정 값들
// ============================================================================

// Wi-Fi 설정 (여기에 사용할 WiFi 이름과 비밀번호를 적어주세요)
const char* WIFI_SSID = "YOUR_WIFI_SSID";       // WiFi 이름 (SSID)
const char* WIFI_PASS = "YOUR_WIFI_PASSWORD";   // WiFi 비밀번호

// 신호 강도 확인 간격 (2초 = 2000밀리초)
const unsigned long RSSI_UPDATE_INTERVAL = 2000;  // 2초마다 신호 강도 확인

// 서보 모터 각도 제어를 위한 신호 강도 기준값
const int RSSI_THRESHOLD_HIGH = 50;  // 신호가 50보다 크면 → 서보 90도
const int RSSI_THRESHOLD_LOW = 30;   // 신호가 30보다 크면 → 서보 45도, 그 이하면 → 서보 0도

// 서보 모터를 연결한 핀 번호
#define SERVO_PIN 9  // 서보 모터를 연결한 핀 번호 (9번 핀)

// ============================================================================
// 상태를 저장하는 변수들
// ============================================================================

Servo servo;

// ============================================================================
// 시작할 때 한 번만 실행되는 함수 (초기화)
// ============================================================================

void setup() {
  // 1단계: 컴퓨터와 통신하기 위한 시리얼 통신 시작
  // 시리얼 모니터에서 메시지를 볼 수 있게 합니다
  Serial.begin(115200);
  delay(100);
  Serial.println(F("\n=== WiFi 신호 강도 모니터 ==="));

  // 2단계: 서보 모터 준비하기
  // 서보 모터를 9번 핀에 연결하고, 처음에는 0도로 설정합니다
  servo.attach(SERVO_PIN);
  servo.write(0);
  Serial.println(F("[초기화] 서보 모터 초기화 완료"));

  // 3단계: WiFi에 연결하기
  connectWiFi();
}

// ============================================================================
// 계속 반복해서 실행되는 함수 (메인 루프)
// ============================================================================

void loop() {
  // 1단계: WiFi가 연결되어 있는지 확인하기
  // 연결이 끊어졌으면 다시 연결을 시도합니다
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println(F("[경고] WiFi 연결이 끊어졌습니다! 재연결 시도 중..."));
    connectWiFi();
  }
  
  // 2단계: WiFi 신호 강도 확인하고 서보 모터 제어하기
  // 2초마다 한 번씩 실행됩니다
  displayWiFiInfo();
  delay(RSSI_UPDATE_INTERVAL);  // 2초 기다리기
}

// ============================================================================
// WiFi 연결 함수들 (네트워크 연결 및 재연결 처리)
// ============================================================================

// WiFi 네트워크에 연결하는 함수
// 연결이 안 되면 30초 동안 계속 시도하고, 실패하면 아두이노를 재시작합니다
void connectWiFi() {
  Serial.print(F("\n[연결] WiFi 연결 중... WiFi 이름: "));
  Serial.println(WIFI_SSID);

  uint8_t retry = 0;  // 시도 횟수를 세는 변수
  while (WiFi.status() != WL_CONNECTED) {
    WiFi.begin(WIFI_SSID, WIFI_PASS);  // WiFi 연결 시도
    delay(500);  // 0.5초 기다리기
    Serial.print(F("."));  // 연결 시도 중임을 표시
    retry++;  // 시도 횟수 증가
    if (retry > 60) { // 60번 시도하면 (약 30초)
      Serial.println();
      Serial.println(F("[연결 실패] WiFi 연결 실패, 재시작 중..."));
      delay(2000);
      NVIC_SystemReset();  // 아두이노 재시작
    }
  }

  Serial.println();
  Serial.println(F("[연결됨] WiFi 연결됨!"));
  Serial.print(F("[IP 주소] "));
  Serial.println(WiFi.localIP());
}

// ============================================================================
// WiFi 신호 표시 함수들 (신호 강도 확인 및 표시)
// ============================================================================

// WiFi 신호 강도를 확인하고 표시하는 함수
// 신호 강도를 확인하고 그에 따라 서보 모터를 제어합니다
void displayWiFiInfo() {
  if (WiFi.status() == WL_CONNECTED) {
    // 1단계: WiFi 신호 강도 확인하기
    // WiFi.RSSI()는 음수로 나오므로 100을 더해서 양수로 만듭니다
    int rssi = WiFi.RSSI() + 100;
 
    // 2단계: 신호 강도 값 출력하기
    Serial.print(F("[신호 강도] "));
    Serial.print(rssi);
    
    // 3단계: 신호 강도에 따라 서보 모터 각도 조절하기
    controlServo(rssi);
  } else {
    Serial.println(F("[오류] WiFi가 연결되지 않았습니다!"));
    // WiFi가 연결되지 않았을 때 서보 모터를 0도로 돌립니다
    servo.write(0);
  }
}

// ============================================================================
// 서보 제어 함수들 (신호 강도에 따른 서보 모터 제어)
// ============================================================================

// 신호 강도에 따라 서보 모터 각도를 조절하는 함수 (3단계 제어)
// 반환값: 실제 RSSI 값에 100을 더한 값 (예: RSSI -50 -> 반환값 50)
void controlServo(int rssi) {
  if (rssi > RSSI_THRESHOLD_HIGH) {
    // 신호가 매우 강함 (50보다 큼) → 서보 모터를 90도로 돌립니다
    servo.write(90);
    Serial.println(F(" [서보 90도]"));
  } else if (rssi > RSSI_THRESHOLD_LOW) {
    // 신호가 보통 (30보다 크고 50 이하) → 서보 모터를 45도로 돌립니다
    servo.write(45);
    Serial.println(F(" [서보 45도]"));
  } else {
    // 신호가 약함 (30 이하) → 서보 모터를 0도로 돌립니다
    servo.write(0);
    Serial.println(F(" [서보 0도]"));
  }
}
